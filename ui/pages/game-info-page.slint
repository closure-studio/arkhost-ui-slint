import { StyleMetrics, ScrollView , VerticalBox, Spinner, Palette, Button } from "std-widgets.slint";
import { GameInfo, GameState, GameLogLoadState, GameLogLoadRequestType, GameInfoViewType, GameOptions } from "../game-info.slint";
import { UserInfo, UserStatus, UserTier, UserProgress } from "../user-info.slint";
import { MockData } from "../mock-data.slint";
import { Callbacks } from "../callbacks.slint";
import { GameCard } from "game-card.slint";
import { BannerNotification } from "../components/banner-notification.slint";
import { StateGlobals, WebViewType, ReleaseUpdateType, ReleaseUpdateState } from "../state-globals.slint";
import { LoadingPlaceholder } from "../components/placeholder-card.slint";
import { MapSelector } from "../components/map-selector.slint";
import { SlotTierCard } from "slot-tier-card.slint";
import { SlotTierConsts } from "../slot-tier-consts.slint";
import { GachaCarouselAutoScroll } from "../components/gacha-carousel.slint";
import { ClosureStudioLogoSingleRow } from "../components/closure-studio-logo.slint";

export enum FetchGamesState {
    NotFetched,
    Fetching,
    Fetched,
    Retrying
}

export enum SseConnectState {
    Disconnected,
    DisconnectedOccupiedElsewhere,
    Connected
}

component FetchGamesIndicator inherits Rectangle {
    in property <[GameInfo]> game-info-list;
    in property <FetchGamesState> fetch-games-state: FetchGamesState.Fetching;
    private property <string> fetch-games-status-text;
    private property <bool> loading;
    private property <[string]> loading-icon-seq: ["ğŸƒ", "ğŸŠ", "ğŸ‡", "ğŸš´", "ğŸš£", "ğŸ§—", "â›·ï¸", "ğŸ§‘â€ğŸ¦½"];
    private property <[string]> retrying-icon-seq: ["âš¡", "ğŸ’£", "ğŸ¤¯", "ğŸ’¥", "â˜¢ï¸", "ğŸš¨", "ğŸ˜±"];
    pure function loading-icon(seq: [string]) -> string {
        seq[floor(mod(animation-tick(), 0.4s * seq.length) / 0.4s)]
    }
    border-radius: 10px;
    background: loading ? Palette.alternate-background : #fff0;
    drop-shadow-blur: StyleMetrics.dark-color-scheme ? 0px : 5px;
    clip: true;
    loading-placeholder := LoadingPlaceholder {
        loading: loading;
        HorizontalLayout {
            spacing: 5px;
            alignment: center;
            if loading: Text {
                text: fetch-games-state == FetchGamesState.Retrying ? loading-icon(retrying-icon-seq) : loading-icon(loading-icon-seq);
                color: Palette.alternate-foreground;
                font-size: 20px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
            Text {
                text: fetch-games-status-text;
                color: Palette.alternate-foreground;
                font-size: 15px;
                vertical-alignment: center;
                horizontal-alignment: center;
            }
        }
    }

    states [
        fetching when fetch-games-state == FetchGamesState.Fetching: {
            loading: true;
            fetch-games-status-text: @tr("æ­£åœ¨åŠ è½½è´¦å·åˆ—è¡¨â€¦â€¦ ");
        }
        empty when fetch-games-state == FetchGamesState.Fetched && game-info-list.length == 0: {
            loading: false;
            fetch-games-status-text: @tr("è¿™é‡Œä¼¼ä¹æ²¡æœ‰æ¸¸æˆè´¦å· ");
        }
        retrying when fetch-games-state == FetchGamesState.Retrying: {
            loading: true;
            fetch-games-status-text: @tr("åŠ è½½è´¦å·åˆ—è¡¨ä¼¼ä¹ä¸å¤ªé¡ºåˆ©â€¦â€¦ ");
        }
    ]
}

component GachaRecordConfirmBox inherits Rectangle {
    in property <bool> is-wide;
    callback confirmed();
    border-radius: 10px;
    background: Palette.alternate-background;
    HorizontalLayout {
        padding-left: 15px;
        padding-right: 15px;
        padding-top: 7px;
        padding-bottom: 7px;
        spacing: 10px;
        alignment: is-wide ? space-between : stretch;
        VerticalLayout {
            alignment: is-wide ? center : space-between;
            spacing: 10px;
            Text {
                text: @tr("ğŸ‰ æœ€è¿‘{}ï¼Œå…¨ç«™æŠ½å–åˆ°äº†ä»¥ä¸Š {} ä½é«˜ç¨€æœ‰åº¦å¹²å‘˜", StateGlobals.gacha-record-time, StateGlobals.gacha-record-count);
                font-size: 15px;
                wrap: word-wrap;
                vertical-alignment: center;
            }

            if !is-wide: HorizontalLayout {
                alignment: end;
                Button {
                    text: @tr("ğŸ˜ å·²é˜…ï¼Œæˆ‘ä¸ç¾¡æ…•");
                    clicked => {
                        confirmed();
                    }
                }
            }
        }

        if is-wide: Button {
            text: @tr("ğŸ˜ å·²é˜…ï¼Œæˆ‘ä¸ç¾¡æ…•");
            clicked => {
                confirmed();
            }
        }
    }
}

export component GameInfoPage {
    in property <UserInfo> user;
    in property <[GameInfo]> game-info-list: [
        MockData.game-info,
        MockData.game-info,
        MockData.game-info,
    ];
    in property <FetchGamesState> fetch-games-state: FetchGamesState.Fetching;
    in property <SseConnectState> sse-connect-state: SseConnectState.Connected;
    private property <string> fetch-games-status-text;
    private property <int> map-selector-target-idx;
    private property <length> map-selector-width: min(self.width - 10px, 350px);
    callback goto-slot-page();
    // TODO: æŠŠå¯¼èˆªå›è°ƒæ”¾åˆ°å…¨å±€

    ScrollView {
        HorizontalLayout {
            private property <bool> is-wide: root.width > 950px;
            alignment: space-around;
            VerticalBox {
                alignment: start;
                padding-left: 10px;
                padding-right: 15px;
                padding-top: 10px;
                spacing: 10px;
                width: min(root.width, 1440px);
                if StateGlobals.update-version != "": BannerNotification {
                    pure function update-action-text() -> string {
                        StateGlobals.update-type == ReleaseUpdateType.FullDownload ? @tr("æ›´æ–°å®¢æˆ·ç«¯") : @tr("å¢é‡æ›´æ–°")
                    }
                    background-color: Palette.alternate-background;
                    accent-color: StyleMetrics.default-text-color;
                    action => {
                        if StateGlobals.update-state == ReleaseUpdateState.Idle {
                            Callbacks.download-update();
                        }
                    }
                    states [
                        idle when StateGlobals.update-state == ReleaseUpdateState.Idle: {
                            text: @tr("ğŸ†• å¯éœ²å¸Œå°”å®¢æˆ·ç«¯æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ - ") + StateGlobals.update-version;
                            has-action: true;
                            action-text: "[" + update-action-text() + "ï¼š" + StateGlobals.update-size + "]";
                        }
                        downloading when StateGlobals.update-state == ReleaseUpdateState.Downloading: {
                            text: @tr("â³ æ­£åœ¨") + update-action-text() + @tr("â€¦  ") + StateGlobals.update-downloaded-size + "/" + StateGlobals.update-size;
                            has-action: false;
                            has-progress: true;
                            progress: StateGlobals.update-progress;
                            indeterminate: StateGlobals.update-indeterminate;
                        }
                        ready when StateGlobals.update-state == ReleaseUpdateState.Ready: {
                            text: @tr("âœ… æ›´æ–°ä¸‹è½½æˆåŠŸï¼å…³é—­å®¢æˆ·ç«¯åå°†è‡ªåŠ¨å¼€å§‹æ›´æ–°ã€‚");
                            has-action: false;
                        }
                    ]
                }
                HorizontalLayout {
                    alignment: stretch;
                    spacing: 10px;
                    Rectangle {
                        background: Palette.alternate-background;
                        border-radius: 10px;
                        clip: true;
                        HorizontalLayout {
                            alignment: stretch;
                            if StateGlobals.site-announcement != "": BannerNotification {
                                background-color: #0000;
                                accent-color: StyleMetrics.default-text-color;
                                has-action: false;
                                text: @tr("ğŸ“¢ ") + StateGlobals.site-announcement;
                                wrap: word-wrap;
                                horizontal-stretch: 1;
                            }
                            if !StateGlobals.is-site-under-maintenance: BannerNotification {
                                background-color: #0000;
                                accent-color: StyleMetrics.default-text-color;
                                has-action: false;
                                text: @tr("ğŸš§ å¯éœ²å¸Œå°”å¹³å°æ­£åœ¨ç»´æŠ¤ä¸­");
                                wrap: word-wrap;
                                horizontal-stretch: 1;
                            }
                        }

                        horizontal-stretch: 1;
                    }

                    HorizontalLayout {
                        spacing: 10px;
                        if is-wide: Rectangle {
                            border-radius: 10px;
                            // å²
                            clip: true;
                            slot-tier-card := SlotTierCard {
                                data: SlotTierConsts.get-tier-card-data(user.tier);
                                width: 540px;
                                x: 0;
                                y: 0;
                            }

                            height: slot-tier-card.height;
                            width: 370px;
                        }
                        Rectangle {
                            background: Palette.control-background;
                            border-radius: 10px;
                            HorizontalLayout {
                                alignment: start;
                                spacing: 10px;
                                padding-left: 10px;
                                padding-right: 10px;
                                padding-top: 7px;
                                padding-bottom: 7px;
                                Rectangle {
                                    ticket-tip-hover := TouchArea {
                                        Button {
                                            primary: true;
                                            text: @tr("å·¥å•ç³»ç»Ÿâ€¦ ");
                                            icon: StyleMetrics.dark-color-scheme ? @image-url("../images/ext_link_light.svg") : @image-url("../images/ext_link.svg");
                                            clicked => {
                                                Callbacks.open-ext-link("https://closure.ltsc.vip/ticket")
                                            }
                                            width: parent.width;
                                            height: parent.height;
                                        }
                                    }

                                    Rectangle {
                                        border-radius: min(10px, self.width / 2);
                                        background: @linear-gradient(15deg, #416f9c 0%, #2f669c 100%);
                                        if self.width > 0px: VerticalLayout {
                                            padding-left: 10px;
                                            alignment: center;
                                            Text {
                                                text: @tr("ğŸ¤— æœ‰é—®é¢˜å’Œå»ºè®®è¯·å‘é€å·¥å•");
                                                font-size: 14px;
                                                color: whitesmoke;
                                                vertical-alignment: top;
                                                horizontal-alignment: left;
                                                overflow: elide;
                                            }
                                        }
                                        width: is-wide && ticket-tip-hover.has-hover ? 220px : 0px;
                                        animate width {
                                            duration: 0.2s;
                                            easing: ease;
                                        }
                                        x: parent.width - self.width;
                                        y: parent.height + 5px;
                                    }

                                    width: 135px;
                                }
                            }
                        }

                        horizontal-stretch: 0;
                        height: 50px;
                    }

                    z: 1;
                }

                if StateGlobals.show-gacha-records && StateGlobals.gacha-record-count > 0: VerticalLayout {
                    // å¤§è‡´ä¼°è®¡
                    property <bool> is-single-row: StateGlobals.gacha-record-count * 100px + 300px < root.width && is-wide;
                    alignment: start;
                    spacing: 5px;
                    HorizontalLayout {
                        alignment: stretch;
                        spacing: 10px;
                        gacha-carousel := GachaCarouselAutoScroll {
                            gacha-groups: StateGlobals.gacha-record;
                            height: self.min-height;
                            horizontal-stretch: 10;
                        }

                        if is-single-row: Rectangle {
                            border-radius: 10px;
                            background: Palette.control-background.transparentize(50%);
                            clip: true;
                            HorizontalLayout {
                                alignment: end;
                                GachaRecordConfirmBox {
                                    background: Palette.alternate-background.transparentize(10%);
                                    is-wide: false;
                                    confirmed => {
                                        Callbacks.confirm-gacha-records();
                                    }
                                }

                                z: 1;
                            }

                            Rectangle {
                                // TODO: èƒŒæ™¯

                                width: 54px;
                                height: 54px;
                                x: 0px;
                                y: parent.height - self.height;
                                z: 0;
                            }

                            horizontal-stretch: 1;
                        }
                    }

                    if !is-single-row: GachaRecordConfirmBox {
                        is-wide: true;
                        confirmed => {
                            Callbacks.confirm-gacha-records();
                        }
                    }
                }
                if user.status == UserStatus.Banned: BannerNotification {
                    background-color: #dd8800;
                    accent-color: #fffceb;
                    text: @tr("ğŸ›‘ ä½ çš„å¯éœ²å¸Œå°”è´¦å·å·²ç»è¢«ç®¡ç†å‘˜åœç”¨");
                }
                if !StateGlobals.has-default-webview-installation && StateGlobals.has-webview-launch-failure: BannerNotification {
                    private property <bool> is-ms-edge-webview2: 
                        StateGlobals.default-webview-installation-type == WebViewType.MicrosoftEdgeWebView2;
                    background-color: #dd8800;
                    accent-color: #fffceb;
                    has-action: true;
                    action-icon: @image-url("../images/ext_link.svg");
                    action => {
                        if is-ms-edge-webview2 {
                            Callbacks.open-ext-link("https://developer.microsoft.com/microsoft-edge/webview2/consumer/");
                        }
                    }
                    states [
                        ms-edge-webview2 when is-ms-edge-webview2: {
                            text: @tr("ğŸš§ å†…ç½®æµè§ˆå™¨å¯åŠ¨å¤±è´¥ï¼Œæ— æ³•è¿›è¡Œè¿›è¡Œæ»‘å—éªŒè¯ç­‰æ“ä½œã€‚è¯·å°è¯•å®‰è£… Microsoft Edge WebView2 åé‡å¯å®¢æˆ·ç«¯ ğŸ‘‰");
                            action-text: @tr("[ä¸‹è½½é¡µé¢]");
                        }
                    ]
                }
                if sse-connect-state != SseConnectState.Connected: BannerNotification {
                    background-color: #dd8800;
                    accent-color: #fffceb;
                    has-action: true;
                    action-text: @tr("[é‡æ–°è¿æ¥]");
                    action => {
                        Callbacks.reconnect-sse();
                    }
                    states [
                        disconnected when sse-connect-state == SseConnectState.Disconnected: {
                            text: @tr("ğŸ“¡ ä¸æœåŠ¡å™¨çš„è¿æ¥æ„å¤–æ–­å¼€ï¼Œè¯·é‡æ–°è¿æ¥ ğŸ‘‰");
                        }
                        disconnected-occupied-elaswhere when sse-connect-state == SseConnectState.DisconnectedOccupiedElsewhere: {
                            text: @tr("ğŸš§ ä½ å·²ç»åœ¨å…¶ä»–ä½ç½®ç™»å…¥å¯éœ²å¸Œå°”ç®¡ç†ç»ˆç«¯ï¼Œè¯·é‡æ–°ä¸Šçº¿ ğŸ‘‰");
                        }
                    ]
                }
                if user.progress == UserProgress.SmsVerifySlotAdded: BannerNotification {
                    background-color: #0661d0;
                    accent-color: #ebf3ff;
                    text: @tr("â° ä½ çš„é¦–ä¸ªè´¦å·åœ¨å¯åŠ¨åå°†å¤„äº24å°æ—¶è¯•ç”¨æœŸï¼Œå¯åŠ¨åè¯·ç•™æ„éªŒè¯ç çŸ­ä¿¡ï¼Œåœ¨è¯•ç”¨æœŸå†…åŠæ—¶å‰å¾€è®¤è¯");
                    has-action: true;
                    action-text: @tr("[å·²æ”¶åˆ°éªŒè¯ç ]");
                    action-icon: @image-url("../images/ext_link.svg");
                    action => {
                        goto-slot-page();
                    }
                }
                if fetch-games-state == FetchGamesState.Fetched && game-info-list.length == 0: BannerNotification {
                    background-color: #0661d0;
                    accent-color: #ebf3ff;
                    text: @tr("ğŸ¤·â€â™‚ï¸ ä½ è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•æ¸¸æˆè´¦å·ï¼Œè¯·å‰å¾€ã€è´¦å·ç®¡ç†ã€‘æ·»åŠ  ğŸ‘‰");
                    has-action: true;
                    action-text: @tr("[è½¬åˆ°è´¦å·ç®¡ç†]");
                    action-icon: @image-url("../images/ext_link.svg");
                    action => {
                        goto-slot-page();
                    }
                }
                for game-info[game-info-idx] in game-info-list: GameCard {
                    info: game-info;
                    start-game(id) => {
                        Callbacks.start-game(id);
                    }
                    stop-game(id) => {
                        Callbacks.stop-game(id);
                    }
                    restart-game(id) => {
                        Callbacks.restart-game(id);
                    }
                    save-options(id, options) => {
                        Callbacks.save-options(id, options);
                    }
                    load-logs(id, type) => {
                        Callbacks.load-logs(id, type);
                    }
                    view-changed(id, type) => {
                        Callbacks.view-changed(id, type);
                    }
                    select-map => {
                        map-selector-target-idx = game-info-idx;
                        map-selector.show();
                    }
                }
                if fetch-games-state != FetchGamesState.NotFetched && game-info-list.length == 0: FetchGamesIndicator {
                    game-info-list: game-info-list;
                    fetch-games-state: fetch-games-state;
                    height: 100px;
                }
            }
        }
    }

    map-selector := PopupWindow {
        private property <GameInfo> target-game: game-info-list[map-selector-target-idx];
        close-on-click: false;
        init => {
            map-selector-control.focus-search-box();
        }
        Rectangle {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            background: Palette.background;
            drop-shadow-blur: 10px;
            drop-shadow-color: #000;
            FocusScope {
                VerticalLayout {
                    padding: 5px;
                    map-selector-control := MapSelector {
                        info: target-game;
                        search-maps(id, term, fuzzy) => {
                            Callbacks.search-maps(id, term, fuzzy);
                        }
                        set-map-selected(id, battle-map, selected) => {
                            Callbacks.set-map-selected(id, battle-map, selected);
                        }
                        reset-selected-maps(id) => {
                            Callbacks.reset-selected-maps(id);
                            map-selector.close();
                        }
                        save-maps(id, maps) => {
                            Callbacks.save-maps(id, maps);
                            map-selector.close();
                        }
                    }
                }

                key-pressed(ev) => {
                    if ev.text == Key.Escape {
                        map-selector-control.reset-selected-maps(target-game.id);
                        EventResult.accept
                    } else {
                        EventResult.reject
                    }
                }
            }
        }

        x: 0px;
        y: 0px;
        width: map-selector-width;
        height: root.height;
    }
}
