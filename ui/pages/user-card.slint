import { GridBox , Button, HorizontalBox, VerticalBox, GroupBox, LineEdit, TextEdit, Palette, Switch } from "std-widgets.slint";
import { UserInfo, UserInfoUtils, UserIdApiRequestState } from "../user-info.slint";
import { MockData } from "../mock-data.slint";
import { Callbacks } from "../callbacks.slint";
import { FontGlobals } from "../font-globals.slint";
import { StateGlobals } from "../state-globals.slint";
import { Theme } from "../theme.slint";

component VerifyInfoBar inherits Rectangle {
    in property <string> button-text;
    in property <bool> button-enabled;
    in property <string> verify-item-name;
    in property <string> verify-item-value;
    callback clicked <=> btn.clicked;
    background: Theme.control-group-background;
    border-radius: 10px;
    clip: true;
    HorizontalLayout {
        alignment: start;
        spacing: 10px;
        padding-left: 10px;
        padding-top: 7px;
        padding-bottom: 7px;
        btn := Button {
            text: button-text;
            enabled: button-enabled;
            primary: button-enabled;
            max-width: 130px;
        }

        if verify-item-value != "": Rectangle {
            border-radius: self.height / 2;
            background: Theme.accent-color-info;
            verify-item-area := TouchArea {
                HorizontalLayout {
                    padding-left: 15px;
                    padding-right: 15px;
                    alignment: center;
                    spacing: 10px;
                    Text {
                        text: verify-item-name;
                        font-family: FontGlobals.closure-studio-logo;
                        font-size: 14px;
                        font-weight: 450;
                        color: whitesmoke;
                        vertical-alignment: center;
                        width: 50px;
                    }

                    Text {
                        text: verify-item-area.has-hover ? verify-item-value : "-----";
                        font-family: FontGlobals.alphanumeric-text-sans;
                        font-size: 16px;
                        color: whitesmoke;
                        vertical-alignment: center;
                        min-width: 200px;
                    }
                }
            }
        }
    }
}

component SmsVerifyArea inherits VerticalLayout {
    in property <UserInfo> user-info;
    in property <bool> requesting;
    out property <bool> sms-dialog-open: false;
    public function open-dialog(){
        if !UserInfoUtils.is-sms-verified(user-info) && !sms-dialog-open {
            sms-dialog-open = true;
        }
    }
    if UserInfoUtils.is-sms-verified(user-info) || !sms-dialog-open: GroupBox {
        title: @tr("Ê∏∏ÊàèË¥¶Âè∑ÂΩíÂ±ûËÆ§ËØÅ");
        VerifyInfoBar {
            verify-item-name: @tr("ÊâãÊú∫Âè∑");
            verify-item-value: UserInfoUtils.is-sms-verified(user-info) ? user-info.phone : "";
            clicked => {
                open-dialog();
            }
            states [
                unauthorized when user-info.uuid == "": {
                    button-enabled: false;
                    button-text: @tr("ËØ∑ÂÖàÁôªÂΩï");
                }
                busy when requesting: {
                    button-enabled: false;
                    button-text: @tr("‚Ä¶");
                }
                sms-unverified when !UserInfoUtils.is-sms-verified(user-info): {
                    button-enabled: true;
                    button-text: @tr("ËøõË°åËÆ§ËØÅ");
                }
                sms-verified when UserInfoUtils.is-sms-verified(user-info): {
                    button-enabled: false;
                    button-text: @tr("Â∑≤ÁªëÂÆö");
                }
            ]
        }
    }
    if !UserInfoUtils.is-sms-verified(user-info) && sms-dialog-open: VerticalLayout {
        function submit-sms-verify-code(){
            Callbacks.submit-sms-verify-code(sms-verify-code-input.text);
        }
        padding-top: 20px;
        spacing: 15px;
        Text {
            font-size: 16px;
            text: 
                @tr("‰Ω†Ê≠£Âú®ËøõË°å„ÄêÊ∏∏ÊàèË¥¶Âè∑ÂΩíÂ±ûËÆ§ËØÅ„ÄëÔºÅ") +
                "\n" +
                @tr("ü§î ‰Ω†ÂèØËÉΩÈúÄË¶ÅËä±‰∏ÄÁÇπÊó∂Èó¥ÈòÖËØª‰∏ãÈù¢ÁöÑËØ¥ÊòéÔºö");
            color: Palette.foreground;
            wrap: word-wrap;
        }

        Text {
            font-size: 14px;
            text: 
                @tr("‚Ñπ ÂΩíÂ±ûËÆ§ËØÅÁî®‰∫éÁ°ÆËÆ§‰Ω†ÂØπÊ≥®ÂÜåÁöÑÊ∏∏ÊàèË¥¶Âè∑Êã•ÊúâÊâÄÊúâÊùÉ„ÄÇÂΩíÂ±ûËÆ§ËØÅÊòØ‰∏∫‰∫ÜÈò≤Ê≠¢Âπ≥Âè∞Ë¢´Êª•Áî®ÔºåÂåÖÊã¨ËÑöÊú¨Ê≥®ÂÜåÂíåÂ§ßÈáèÊâòÁÆ°ÈùûËá™ÊúâË¥¶Âè∑„ÄÇ‰Ω†ÈúÄË¶Å„Äê‰∏Ä‰∏™„ÄëÂΩíÂ±ûËÆ§ËØÅË¥¶Âè∑Êù•Ê≠£Â∏∏‰ΩøÁî®Âπ≥Âè∞ÁöÑÊâÄÊúâÂäüËÉΩ„ÄÇ") +
                "\n" +
                "\n" +    
                @tr("üîë ÂΩíÂ±ûËÆ§ËØÅÁî®Ë¥¶Âè∑Ê†è‰ΩçÊéíÂú®Á¨¨‰∏Ä‰ΩçÔºàSlot #1Ôºâ„ÄÇËØ•Ë¥¶Âè∑Ê†è‰Ωç‰ªÖËÉΩÁî®‰∫éÊ∑ªÂä† ‚òé ÊâãÊú∫Âè∑Ê∏∏ÊàèË¥¶Âè∑„ÄÇËØ∑Â°´ÂÜôËÉΩÂ§üÁôªÂΩïÊ∏∏ÊàèÁöÑÊâãÊú∫Âè∑Ë¥¶Âè∑ÔºåÊ∑ªÂä†Ê∏∏ÊàèË¥¶Âè∑ÂêéÔºåËØ∑ÂâçÂæÄÂÆ¢Êà∑Á´ØÈ¶ñÂ±èÂêØÂä®ÊâòÁÆ°ÔºåÁ≠âÂæÖ2-5ÂàÜÈíüÁ°ÆËÆ§Ê∏∏ÊàèËøõÂÖ•ÊâòÁÆ°Áä∂ÊÄÅÔºåÊúüÈó¥ËØ∑‰∏çË¶ÅÈÄÄÂá∫ÂÆ¢Êà∑Á´Ø„ÄÇ") +
                "\n" +
                "\n" +
                @tr("üì© ÂΩìËØ•Ë¥¶Âè∑ÁôªÂΩïÊàêÂäüÂπ∂ËøõÂÖ•ÊâòÁÆ°Áä∂ÊÄÅÊó∂ÔºåÂπ≥Âè∞Â∞ÜÂêëÂØπÂ∫îÁöÑÊâãÊú∫Âè∑ÂèëÈÄÅ„ÄêÂèØÈú≤Â∏åÂ∞î‰∫ëÂπ≥Âè∞„ÄëÂºÄÂ§¥ÁöÑÈ™åËØÅÁü≠‰ø°„ÄÇÂ°´ÂÜôÊ≠£Á°ÆÈ™åËØÅÁ†ÅÂêéÔºåÂπ≥Âè∞Âç≥Á°ÆËÆ§ËØ•Ê∏∏ÊàèË¥¶Âè∑ÁöÑÊâÄÊúâÊùÉ„ÄÇ‰Ω†Â∞ÜÂèØ‰ª•Ê≠£Â∏∏‰ΩøÁî®Âπ≥Âè∞ÁöÑÊâÄÊúâÊúçÂä°ÔºåÂêåÊó∂Ëß£ÈîÅ‰Ωô‰∏ãÁöÑÈÄöÁî®ÊâòÁÆ°Ê†è‰ΩçÔºà‰∏çË¶ÅÊ±ÇÂΩíÂ±ûËÆ§ËØÅÊàñÊâãÊú∫Âè∑Ôºâ„ÄÇ") +
                "\n" +
                "\n" +
                @tr("üîí ÂΩíÂ±ûËÆ§ËØÅÂÆåÊàêÂêéÔºåËØ•ÊâãÊú∫Âè∑Ê∏∏ÊàèË¥¶Âè∑Â∞ÜÁªëÂÆöËá≥Âπ≥Âè∞Ë¥¶Âè∑Ôºåüîë ËØ∑Áâ¢ËÆ∞Âπ≥Âè∞Áî®Êà∑ÂêçÂíåÂØÜÁ†ÅÔºåÊ≥®ÂÜåÂÖ∂‰ªñÂπ≥Âè∞Ë¥¶Âè∑Êó†Ê≥ïÂÜçÊ¨°ÊâòÁÆ°ËØ•Ê∏∏ÊàèË¥¶Âè∑„ÄÇ") +
                "\n"+
                "\n" +
                @tr("üöß Â¶ÇÊûú‰Ω†ÁöÑÂ∏∏Áî®Ê∏∏ÊàèË¥¶Âè∑Âõ†Ê≠ªÁªëÂè∑Á≠âÂéüÂõ†Êó†Ê≥ïÊé•Êî∂Áü≠‰ø°ÔºåËØ∑Áî®‰Ω†ÁöÑÊâãÊú∫Âè∑Âú®Ê∏∏Êàè‰∏≠Ê≥®ÂÜåÂè¶‰∏ÄÊ∏∏ÊàèË¥¶Âè∑Áî®‰∫éÂΩíÂ±ûËÆ§ËØÅ„ÄÇ") +
                "\n" +
                "\n" +
                @tr("üóëÔ∏è Ê∏∏ÊàèÁôªÂΩïÊàêÂäüÂêéÈïøÊó∂Èó¥Êú™Êî∂Âà∞Áü≠‰ø°ÔºåËØ∑ÂÖàÊ£ÄÊü•‰Ω†ÁöÑÈ™öÊâ∞Êã¶Êà™Áü≠‰ø°Êñá‰ª∂Â§π„ÄÇüÜò Á°ÆËÆ§Êú™Êî∂Âà∞È™åËØÅÁü≠‰ø°„ÄÅÂú®ÂΩíÂ±ûËÆ§ËØÅ‰∏≠ÈÅáÂà∞ÂÖ∂‰ªñÁâπÊÆäÊÉÖÂÜµÔºåËØ∑Êèê‰∫§Â∑•ÂçïÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò„ÄÇ");
            wrap: word-wrap;
        }

        sms-verify-code-input := LineEdit {
            font-size: 15px;
            enabled: !requesting;
            horizontal-alignment: center;
            input-type: number;
            placeholder-text: @tr("ËØ∑ËæìÂÖ•ÂèëÈÄÅÂà∞„ÄêÂΩíÂ±ûËÆ§ËØÅÊâãÊú∫Âè∑„ÄëÁöÑÈ™åËØÅÁ†Å");
            accepted => {
                if self.text != "" {
                    submit-sms-verify-code();
                }
            }
        }

        HorizontalLayout {
            alignment: end;
            spacing: 10px;
            Button {
                enabled: !requesting;
                text: @tr("ËøîÂõû");
                clicked => {
                    sms-verify-code-input.text = "";
                    sms-dialog-open = false;
                }
            }

            Button {
                enabled: !requesting && sms-verify-code-input.text != "";
                text: @tr("Êèê‰∫§");
                primary: true;
                clicked => {
                    submit-sms-verify-code();
                }
            }
        }
    }
}

component QQVerifyArea inherits VerticalLayout {
    in property <UserInfo> user-info;
    in property <bool> requesting;
    out property <bool> qq-dialog-open: false;
    private property <bool> qq-verify-code-copied: false;
    public function open-dialog(){
        if !UserInfoUtils.is-qq-verified(user-info) && !qq-dialog-open {
            Callbacks.fetch-qq-verify-code();
            qq-verify-code-copied = false;
            qq-dialog-open = true;
        }
    }
    if UserInfoUtils.is-qq-verified(user-info) || !qq-dialog-open: GroupBox {
        title: @tr("QQËÆ§ËØÅ");
        VerifyInfoBar {
            verify-item-name: @tr("QQ");
            verify-item-value: UserInfoUtils.is-qq-verified(user-info) ? user-info.qq : "";
            clicked => {
                open-dialog();
            }
            states [
                unauthorized when user-info.uuid == "": {
                    button-enabled: false;
                    button-text: @tr("ËØ∑ÂÖàÁôªÂΩï");
                }
                busy when requesting: {
                    button-enabled: false;
                    button-text: @tr("‚Ä¶");
                }
                sms-unverified when !UserInfoUtils.is-sms-verified(user-info): {
                    button-enabled: false;
                    button-text: @tr("ËØ∑ÂÖàÂÆåÊàêÂΩíÂ±ûÊâãÊú∫Âè∑ËÆ§ËØÅ");
                }
                qq-unverified when !UserInfoUtils.is-qq-verified(user-info): {
                    button-enabled: true;
                    button-text: @tr("Ëé∑ÂèñQQÈ™åËØÅ‰ª£Á†Å");
                }
                verified when UserInfoUtils.is-qq-verified(user-info): {
                    button-enabled: false;
                    button-text: @tr("Â∑≤ÁªëÂÆö");
                }
            ]
        }
    }
    if !UserInfoUtils.is-qq-verified(user-info) && qq-dialog-open && user-info.qq-verify-code-cached != "": VerticalLayout {
        padding-top: 20px;
        spacing: 15px;
        Text {
            font-size: 14px;
            text: @tr("ËØ∑ÂâçÂéªÂèØÈú≤Â∏åÂ∞îÂÆòÊñπQQÁæ§Á≤òË¥¥Âπ∂ÂèëÈÄÅÊï¥Êù°È™åËØÅÁ†ÅËá≥Áæ§ÂÜÖËøõË°åÈ™åËØÅ„ÄÇ");
            color: Palette.foreground.transparentize(30%);
            wrap: word-wrap;
        }

        Button {
            padding: 30px;
            enabled: !requesting;
            text: @tr("Â§çÂà∂QQÈ™åËØÅ‰ª£Á†Å");
            primary: !qq-verify-code-copied;
            clicked => {
                qq-verify-code-text.select-all();
                qq-verify-code-text.copy();
                qq-verify-code-copied = true;
            }
        }

        VerticalLayout {
            alignment: start;
            spacing: 15px;
            Text {
                font-size: 14px;
                text: @tr("QQÈ™åËØÅ‰ª£Á†ÅÂ∑≤ÁªèÂ§çÂà∂Âà∞‰Ω†ÁöÑÂâ™ÂàáÊùø„ÄÇ\nÂ¶ÇÊûú‰Ω†ÁöÑÂâ™ÂàáÊùø‰∏∫Á©∫ÔºåËØ∑Ê°ÜÈÄâÂ§çÂà∂‰∏ãÊñπÁöÑÈ™åËØÅÁ†ÅÊñáÊú¨Ôºö");
                color: Palette.foreground.transparentize(30%);
                wrap: word-wrap;
            }

            qq-verify-code-text := TextInput {
                font-size: 15px;
                text: user-info.qq-verify-code-cached;
                horizontal-alignment: center;
                read-only: true;
            }

            visible: qq-verify-code-copied;
            height: !qq-verify-code-copied ? 0px : 75px;
        }

        HorizontalLayout {
            padding-top: 10px;
            alignment: space-between;
            Button {
                text: @tr("Ëé∑ÂèñÂä†Áæ§ÈìæÊé•‚Ä¶");
                icon: @image-url("../images/ext_link.svg");
                colorize-icon: true;
                clicked => {
                    Callbacks.open-ext-link(@tr("https://closure.ltsc.vip"));
                }
            }

            HorizontalLayout {
                alignment: end;
                spacing: 10px;
                Button {
                    enabled: !requesting;
                    text: @tr("ËøîÂõû");
                    clicked => {
                        qq-dialog-open = false;
                    }
                }

                Button {
                    enabled: !requesting;
                    text: @tr("Âà∑Êñ∞QQÈ™åËØÅÁä∂ÊÄÅ");
                    primary: qq-verify-code-copied;
                    clicked => {
                        Callbacks.refresh-user-info();
                        if user-info.qq-verify-code-cached != "" {
                            Callbacks.fetch-qq-verify-code();
                        }
                    }
                }
            }
        }
    }
}

export component UserCard inherits Rectangle {
    in property <UserInfo> user-info: MockData.user-info;
    out property <bool> sms-dialog-open: sms-verify-area.sms-dialog-open;
    out property <bool> qq-dialog-open: qq-verify-area.qq-dialog-open;
    private property <bool> requesting: user-info.id-api-request-state == UserIdApiRequestState.Requesting;
    public function open-qq-verify-dialog(){
        qq-verify-area.open-dialog();
    }
    public function open-sms-verify-dialog(){
        sms-verify-area.open-dialog();
    }
    border-radius: 10px;
    background: Palette.alternate-background;
    drop-shadow-blur: Palette.color-scheme == ColorScheme.dark ? 0px : 5px;
    drop-shadow-color: darkgray;
    clip: true;
    layout := VerticalLayout {
        alignment: start;
        padding: 20px;
        GridLayout {
            spacing: 10px;
            Rectangle {
                width: 64px;
                height: 64px;
                border-radius: 24px;
                clip: true;
                Image {
                    // ÂçöÂ£´Â§¥ÂÉè
                    source: @image-url("../images/closure_logo.png");
                    width: 64px;
                    height: 64px;
                }

                row: 0;
                col: 0;
            }

            VerticalLayout {
                spacing: 2px;
                Text {
                    font-size: 12px;
                    font-family: FontGlobals.closure-studio-logo;
                    color: Palette.foreground.transparentize(30%);
                    text: "Doctor ID";
                    vertical-alignment: bottom;
                    height: 22px;
                }

                Text {
                    font-size: 20px;
                    font-family: FontGlobals.alphanumeric-text-sans;
                    text: user-info.uuid == "" ? "Dr. Breen" : user-info.nickname;
                    overflow: clip;
                    vertical-alignment: top;
                }

                row: 0;
                col: 1;
            }

            VerticalLayout {
                alignment: center;
                Button {
                    enabled: !requesting;
                    text: requesting ? @tr("Âà∑Êñ∞‰∏≠") : @tr("Âà∑Êñ∞");
                    icon: @image-url("../images/user_card_refresh.svg");
                    colorize-icon: true;
                    clicked => {
                        Callbacks.refresh-user-info();
                        if user-info.qq-verify-code-cached != "" {
                            Callbacks.fetch-qq-verify-code();
                        }
                    }
                    width: 90px;
                    height: 30px;
                }

                row: 0;
                col: 2;
            }
        }

        sms-verify-area := SmsVerifyArea {
            user-info: user-info;
            requesting: requesting;
        }

        qq-verify-area := QQVerifyArea {
            user-info: user-info;
            requesting: requesting;
        }

        GroupBox {
            title: @tr("ÂÖ∂‰ªñ");
            Rectangle {
                misc-menu := GridLayout {
                    spacing-horizontal: 5px;
                    spacing-vertical: 5px;
                    Button {
                        text: @tr("Â§çÂà∂Áî®Êà∑ ID");
                        clicked => {
                            uuid-dummy.select-all();
                            uuid-dummy.copy();
                            uuid-dummy.clear-selection();
                        }
                        row: 0;
                        col: 0;
                    }

                    Button {
                        text: @tr("ÂõûÂà∞ÁôªÂΩïÁïåÈù¢");
                        clicked => {
                            Callbacks.return-to-login-page();
                        }
                        row: 0;
                        col: 1;
                    }

                    Button {
                        property <bool> calculated: StateGlobals.data-disk-usage != "" && StateGlobals.cache-disk-usage != "";
                        clicked => {
                            if !calculated {
                                Callbacks.recalculate-data-disk-usage();
                            } else {
                                Callbacks.set-clean-data(!StateGlobals.clean-data-requested);
                            }
                        }
                        states [
                            not-calculated when !calculated: {
                                text: @tr("ËÆ°ÁÆó App Êï∞ÊçÆÂç†Áî®Á©∫Èó¥");
                            }
                            normal when !StateGlobals.clean-data-requested: {
                                text: @tr("Ê∏ÖÈô§ App Êï∞ÊçÆ [ÊÄªÂç†Áî®Ôºö{} ËµÑÊ∫êÁºìÂ≠òÔºö{}]", StateGlobals.data-disk-usage, StateGlobals.cache-disk-usage);
                            }
                            clean-requested when StateGlobals.clean-data-requested: {
                                text: @tr("ÂèñÊ∂àÊ∏ÖÈô§Êï∞ÊçÆÔºàApp ÈÄÄÂá∫Êó∂Â∞ÜÊ∏ÖÈô§Ôºâ");
                            }
                        ]
                        row: 1;
                        col: 0;
                        colspan: 2;
                    }

                    HorizontalBox {
                        alignment: stretch;
                        Switch {
                            text: @tr("‰ΩéÊï∞ÊçÆÊ®°Âºè");
                            checked: StateGlobals.data-saver-mode-enabled;
                            toggled => {
                                Callbacks.set-data-saver-mode(self.checked);
                            }
                            width: 140px;
                        }

                        Text {
                            text: @tr("‚Ñπ ‰ΩéÊï∞ÊçÆÊ®°Âºè‰∏çÂä†ËΩΩÂõæÁâáËµÑÊ∫êÔºåÂ∞ÜÂä†Âø´ÂêØÂä®Âπ∂Èôç‰ΩéÁºìÂ≠òÁ©∫Èó¥Âç†Áî®ÔºåÈáçÂêØ App ÁîüÊïà ");
                            wrap: word-wrap;
                        }

                        row: 2;
                        col: 0;
                        colspan: 2;
                    }

                    x: 0;
                    y: 0;
                }

                uuid-dummy := TextInput {
                    accessible-role: none;
                    accessible-checkable: false;
                    visible: false;
                    text: user-info.uuid;
                    width: 0;
                    height: 0;
                }

                height: misc-menu.min-height;
            }
        }
    }

    height: layout.min-height;
    animate height {
        duration: 0.25s;
        easing: ease;
    }
}
