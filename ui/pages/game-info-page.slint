import { GameInfo, GameState, GameLogLoadState, GameLogLoadRequestType, GameInfoViewType, GameOptions } from "../game-info.slint";
import { UserInfo, UserStatus, UserProgress } from "../user-info.slint";
import { MockData } from "../mock-data.slint";
import { Callbacks } from "../callbacks.slint";
import { GameCard } from "game-card.slint";
import { ScrollView , VerticalBox, Spinner} from "std-widgets.slint";
import { BannerNotification } from "../components/banner-notification.slint";

export enum FetchGamesState {
    NotFetched,
    Fetching,
    Fetched,
    Retrying
}

export enum SseConnectState {
    Disconnected,
    DisconnectedOccupiedElsewhere,
    Connected
}

component FetchGamesIndicator inherits VerticalBox {
    alignment: start;
    in property <[GameInfo]> game-info-list;
    in property <FetchGamesState> fetch-games-state;
    private property <string> fetch-games-status-text;

    if fetch-games-state != FetchGamesState.NotFetched 
    && game-info-list.length == 0: VerticalLayout {
    alignment: start;
    HorizontalLayout {
            alignment: center;
            spacing: 10px;

            Text {
                text: fetch-games-status-text;
                vertical-alignment: center;
            }

            if fetch-games-state != FetchGamesState.Fetched : Spinner {
                indeterminate: true;
            }

            height: 50px;
        }
    } 

    states [
        fetching when fetch-games-state == FetchGamesState.Fetching: {
            fetch-games-status-text: @tr("Ê≠£Âú®Âä†ËΩΩË¥¶Âè∑ÂàóË°®‚Ä¶‚Ä¶ ");
        }
        empty when fetch-games-state == FetchGamesState.Fetched && game-info-list.length == 0: {
            fetch-games-status-text: @tr("ËøôÈáå‰ºº‰πéÊ≤°ÊúâÊ∏∏ÊàèË¥¶Âè∑ ");
        }
        retrying when fetch-games-state == FetchGamesState.Retrying: {
            fetch-games-status-text: @tr("Âä†ËΩΩË¥¶Âè∑ÂàóË°®‰ºº‰πé‰∏çÂ§™È°∫Âà©‚Ä¶‚Ä¶ ");
        }
    ]
}

export component GameInfoPage {
    in property <UserInfo> user;
    in property <[GameInfo]> game-info-list: [
        MockData.game-info,
        MockData.game-info,
        MockData.game-info,
    ];
    in property <FetchGamesState> fetch-games-state;
    in property <SseConnectState> sse-connect-state;
    private property <string> fetch-games-status-text;

    callback goto-slot-page(); // TODO: ÊääÂØºËà™ÂõûË∞ÉÊîæÂà∞ÂÖ®Â±Ä

    ScrollView {
        HorizontalLayout {
            alignment: space-around;

            VerticalBox {
                alignment: start;
                padding-left: 10px;
                padding-right: 15px;
                padding-top: 10px;
                spacing: 10px;

                width: min(root.width, 1440px);

                if user.status == UserStatus.Banned : BannerNotification {
                    background-color: #8d7800ee;
                    accent-color: #fffceb;
                    text: @tr("üõë ‰Ω†ÁöÑÂèØÈú≤Â∏åÂ∞îË¥¶Âè∑Â∑≤ÁªèË¢´ÂÅúÁî®");
                }

                if user.progress == UserProgress.SmsVerifySlotAdded: BannerNotification {
                    background-color: #00649ebb;
                    accent-color: #ebf3ff;
                    text: @tr("‚è∞ ‰Ω†ÁöÑÈ¶ñ‰∏™Ë¥¶Âè∑Âú®ÂêØÂä®ÂêéÂ∞ÜÂ§Ñ‰∫é24Â∞èÊó∂ËØïÁî®ÊúüÔºåÂêØÂä®ÂêéËØ∑Ê≥®ÊÑèÊü•Êî∂È™åËØÅÁ†ÅÔºåÂèäÊó∂ÂâçÂæÄËÆ§ËØÅ");
                    has-action: true;
                    action-text: @tr("[ËΩ¨Âà∞Ë¥¶Âè∑ÁÆ°ÁêÜ]");
                    action-icon: @image-url("../images/ext_link.svg");
                    action => { goto-slot-page(); }
                }
    
                if sse-connect-state != SseConnectState.Connected: BannerNotification {
                    background-color: #8d7800ee;
                    accent-color: #fffceb;
                    has-action: true;
                    action-text: @tr("[ÈáçÊñ∞ËøûÊé•]");
                    action => { Callbacks.reconnect-sse(); }
    
                    states [
                        disconnected when sse-connect-state == SseConnectState.Disconnected: {
                            text: @tr("üì° ‰∏éÊúçÂä°Âô®ÁöÑËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑ÈáçÊñ∞ËøûÊé•");
                        }
                        disconnected-occupied-elaswhere when 
                            sse-connect-state == SseConnectState.DisconnectedOccupiedElsewhere: {
                            text: @tr("üöß ‰Ω†Â∑≤ÁªèÂú®ÂÖ∂‰ªñ‰ΩçÁΩÆÊâìÂºÄÂèØÈú≤Â∏åÂ∞îÁªàÁ´ØÔºåËØ∑ÈáçÊñ∞ËøûÊé•");
                        }
                    ]
                }
    
                if fetch-games-state == FetchGamesState.Fetched && game-info-list.length == 0: BannerNotification {
                    background-color: #00649ebb;
                    accent-color: #ebf3ff;
                    text: @tr("ü§∑‚Äç‚ôÇÔ∏è ‰Ω†ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïÊ∏∏ÊàèË¥¶Âè∑ÔºåËØ∑ÂâçÂæÄ„ÄêË¥¶Âè∑ÁÆ°ÁêÜ„ÄëÊ∑ªÂä†");
                    has-action: true;
                    action-text: @tr("[ËΩ¨Âà∞Ë¥¶Âè∑ÁÆ°ÁêÜ]");
                    action-icon: @image-url("../images/ext_link.svg");
                    action => { goto-slot-page(); }
                }
    
                for game-info in game-info-list: GameCard {
                    info: game-info;
    
                    start-game(id) => { Callbacks.start-game(id); }
                    stop-game(id) => { Callbacks.stop-game(id); }
                    restart-game(id) => { Callbacks.restart-game(id); }
                    save-options(id, options) => { Callbacks.save-options(id, options); }
                    load-logs(id, type) => { Callbacks.load-logs(id, type); }
                    view-changed(id, type) => { Callbacks.view-changed(id, type); }
                }
    
                FetchGamesIndicator {
                    game-info-list: game-info-list;
                    fetch-games-state: fetch-games-state;
                }
            }
        }
    }
}
