import { GridBox , Button, HorizontalBox, VerticalBox, StyleMetrics , GroupBox, LineEdit, TextEdit, StandardButton} from "std-widgets.slint";
import { UserInfo, UserInfoUtils, UserIdApiRequestState } from "../user-info.slint";
import { MockData } from "../mock-data.slint";
import { Callbacks } from "../callbacks.slint";
import { FontGlobals } from "../font-globals.slint";

component SmsVerifyArea inherits VerticalLayout {
    in property <UserInfo> user-info;
    in property <bool> requesting;
    out property <bool> sms-dialog-open: false;

    public function open-dialog() {
        if !UserInfoUtils.is-sms-verified(user-info) && !sms-dialog-open {
            sms-dialog-open = true;
        }
    }
    
    if UserInfoUtils.is-sms-verified(user-info) || !sms-dialog-open : GroupBox {
        title: @tr("æ¸¸æˆè´¦å·å½’å±žè®¤è¯");
        
        Button {
            enabled: true; // åˆå§‹å€¼ï¼Œä¼šè¢«statesä¿®æ”¹

            clicked => { open-dialog(); }
            width: 300px;

            states [
                busy when requesting: {
                    enabled: false;
                    text: @tr("â€¦");
                }
                sms-unverified when !UserInfoUtils.is-sms-verified(user-info) : {
                    enabled: true;
                    text: @tr("è¿›è¡Œè®¤è¯");
                }
                sms-verified when UserInfoUtils.is-sms-verified(user-info) : {
                    enabled: false;
                    text: @tr("å·²ç»‘å®šåˆ°ï¼š") + user-info.phone;
                }
            ]
        }
    }

    if !UserInfoUtils.is-sms-verified(user-info) && sms-dialog-open: VerticalLayout {
        function submit-sms-verify-code() {
            Callbacks.submit-sms-verify-code(sms-verify-code-input.text);
        }

        padding-top: 20px;
        spacing: 15px;

        Text {
            font-size: 16px;
            text: @tr("ä½ æ­£åœ¨è¿›è¡Œã€æ¸¸æˆè´¦å·å½’å±žè®¤è¯ã€‘ï¼")
                + "\n" + @tr("ðŸ¤” ä½ å¯èƒ½éœ€è¦èŠ±ä¸€ç‚¹æ—¶é—´å®Œæ•´é˜…è¯»ä¸‹é¢çš„è¯´æ˜Žï¼š");
            color: StyleMetrics.default-text-color;
            wrap: word-wrap;
        }   

        Text {
            font-size: 14px;
            text: @tr("â˜ŽðŸ“© è¯·åœ¨ç¬¬ä¸€ä¸ªè´¦å·æ ä½æ·»åŠ ã€æ‰‹æœºå·ã€‘æ¸¸æˆè´¦å·ï¼Œæ¸¸æˆç™»å½•æˆåŠŸåŽï¼Œå¯éœ²å¸Œå°”å°†å‘è¯¥å·ç å‘é€éªŒè¯çŸ­ä¿¡ï¼Œè¾“å…¥éªŒè¯ç å®Œæˆæ¸¸æˆè´¦å·å½’å±žè®¤è¯ã€‚\nï¼ˆçœæµï¼šâ˜ŽðŸ“©=â˜ŽðŸŽ®ï¼‰") 
                + "\n"
                + "\n" + @tr("ðŸ”’ å®Œæˆå½’å±žè®¤è¯åŽè¯¥æ‰‹æœºå·åŠå…¶æ¸¸æˆæ‰˜ç®¡å°†è¢«ç»‘å®šè‡³å¯éœ²å¸Œå°”è´¦å·ï¼Œä¸æ”¯æŒæ¢ç»‘ã€è§£ç»‘æ“ä½œã€‚ðŸ”‘ è¯·å‹¿ä¸¢å¤±ä½ çš„å¯éœ²å¸Œå°”è´¦å·å¯†ç ï¼Œä»¥å…æ— æ³•å†æ¬¡æ·»åŠ æ‰˜ç®¡è¯¥æ¸¸æˆè´¦å·ã€‚")
                + "\n"
                + "\n" + @tr("â›” å¦‚æžœåœ¨å¯åŠ¨æ¸¸æˆåŽçš„24å°æ—¶å†…æœªå®Œæˆè®¤è¯ï¼Œæ¸¸æˆè´¦å·å°†ä¸­æ­¢æ‰˜ç®¡ã€‚")
                + "\n"
                + "\n" + @tr("ðŸš§ å¦‚æžœä½ çš„å¸¸ç”¨æ¸¸æˆè´¦å·å› æ­»ç»‘å·ç­‰åŽŸå› æ— æ³•æŽ¥æ”¶çŸ­ä¿¡ï¼Œè¯·å…ˆç”¨ä½ çš„æ‰‹æœºå·ã€åœ¨æ¸¸æˆå†…ã€‘æ³¨å†Œã€æ–°æ¸¸æˆè´¦å·ã€‘ç”¨äºŽå½’å±žè®¤è¯ï¼Œå†ç»§ç»­æ·»åŠ å¸¸ç”¨è´¦å·è‡³å¦ä¸€è´¦å·æ ä½ã€‚")
                + "\n"
                + "\n" + @tr("ðŸ—‘ï¸ æ¸¸æˆç™»å½•æˆåŠŸåŽé•¿æ—¶é—´æœªæ”¶åˆ°çŸ­ä¿¡ï¼Œè¯·å…ˆæ£€æŸ¥ä½ çš„éªšæ‰°æ‹¦æˆªçŸ­ä¿¡æ–‡ä»¶å¤¹ã€‚ðŸ†˜ ç¡®è®¤æœªæ”¶åˆ°ã€åœ¨å½’å±žè®¤è¯ä¸­é‡åˆ°å…¶ä»–ç‰¹æ®Šæƒ…å†µï¼Œè¯·è”ç³»å¯éœ²å¸Œå°”å¹³å°ç®¡ç†å‘˜ã€‚");
            color: StyleMetrics.default-text-color.transparentize(20%);
            wrap: word-wrap;
        }

        sms-verify-code-input := LineEdit {
            font-size: 15px;
            enabled: !requesting;
            horizontal-alignment: center;
            input-type: number;
            placeholder-text: @tr("è¯·è¾“å…¥å‘é€åˆ°ã€å½’å±žè®¤è¯æ‰‹æœºå·ã€‘çš„éªŒè¯ç ");
            accepted => { 
                if self.text != "" {
                    submit-sms-verify-code();
                }
            }
        }

        HorizontalLayout {
            alignment: end;
            spacing: 10px;

            Button {
                enabled: !requesting;
                text: @tr("è¿”å›ž");
                clicked => { 
                    sms-verify-code-input.text = "";
                    sms-dialog-open = false; 
                }
            }

            Button {
                enabled: !requesting && sms-verify-code-input.text != "";
                text: @tr("æäº¤");
                primary: true;
                clicked => { submit-sms-verify-code(); }
            }
        }
    }
}

component QQVerifyArea inherits VerticalLayout {
    in property <UserInfo> user-info;
    in property <bool> requesting;
    out property <bool> qq-dialog-open: false;

    private property <bool> qq-verify-code-copied: false;

    public function open-dialog() {
        if !UserInfoUtils.is-qq-verified(user-info) && !qq-dialog-open {
            Callbacks.fetch-qq-verify-code();
            qq-verify-code-copied = false;
            qq-dialog-open = true;
        }
    }

    if UserInfoUtils.is-qq-verified(user-info) || !qq-dialog-open : GroupBox {
        title: @tr("QQè®¤è¯");

        open-dialog-btn := Button {
            enabled: true; // åˆå§‹å€¼ï¼Œä¼šè¢«statesä¿®æ”¹
            width: 300px;
            clicked => {
                open-dialog();
            }

            states [
                busy when requesting: {
                    enabled: false;
                    text: @tr("â€¦");
                }
                sms-unverified when !UserInfoUtils.is-sms-verified(user-info): {
                    enabled: false;
                    text: @tr("è¯·å…ˆå®Œæˆå½’å±žæ‰‹æœºå·è®¤è¯");
                }
                qq-unverified when !UserInfoUtils.is-qq-verified(user-info): {
                    enabled: true;
                    text: @tr("èŽ·å–QQéªŒè¯ä»£ç ");
                }
                verified when UserInfoUtils.is-qq-verified(user-info): {
                    enabled: false;
                    text: @tr("å·²ç»‘å®šåˆ°ï¼š") + user-info.qq;
                }
            ]
        }
    }

    if !UserInfoUtils.is-qq-verified(user-info) 
        && qq-dialog-open 
        && user-info.qq-verify-code-cached != "" : VerticalLayout {
        padding-top: 20px;
        spacing: 15px;

        Text {
            font-size: 14px;
            text: @tr("è¯·å‰åŽ»å¯éœ²å¸Œå°”å®˜æ–¹QQç¾¤ç²˜è´´å¹¶å‘é€æ•´æ¡éªŒè¯ç è‡³ç¾¤å†…è¿›è¡ŒéªŒè¯ã€‚");
            color: StyleMetrics.default-text-color.transparentize(30%);
            wrap: word-wrap;
        }

        Button {
            padding: 30px;
            enabled: !requesting;

            text: @tr("å¤åˆ¶QQéªŒè¯ä»£ç ");
            primary: !qq-verify-code-copied;

            clicked => { 
                qq-verify-code-text.select-all();
                qq-verify-code-text.copy();
                qq-verify-code-copied = true;
            }
        }

        VerticalLayout {
            alignment: start;
            spacing: 15px;

            Text {
                font-size: 14px;
                text: @tr("QQéªŒè¯ä»£ç å·²ç»å¤åˆ¶åˆ°ä½ çš„å‰ªåˆ‡æ¿ã€‚\nå¦‚æžœä½ çš„å‰ªåˆ‡æ¿ä¸ºç©ºï¼Œè¯·æ¡†é€‰å¤åˆ¶ä¸‹æ–¹çš„éªŒè¯ç æ–‡æœ¬ï¼š");
                color: StyleMetrics.default-text-color.transparentize(30%);
                wrap: word-wrap;
            }

            qq-verify-code-text := TextInput {
                font-size: 15px;
                text: user-info.qq-verify-code-cached;
                horizontal-alignment: center;
                read-only: true;
            }

            visible: qq-verify-code-copied;
            height: !qq-verify-code-copied 
                ? 0px
                : 75px;
        }

        HorizontalLayout {
            padding-top: 10px;

            alignment: space-between;

            Button {
                text: @tr("èŽ·å–åŠ ç¾¤é“¾æŽ¥â€¦");
                icon: StyleMetrics.dark-color-scheme
                    ? @image-url("../images/ext_link.svg")
                    : @image-url("../images/ext_link_light.svg");

                clicked => { Callbacks.open-ext-link(@tr("https://closure.ltsc.vip")); }
            }

            HorizontalLayout {
                alignment: end;
                spacing: 10px;

                Button {
                    enabled: !requesting;
                    text: @tr("è¿”å›ž");
                    clicked => { qq-dialog-open = false; }
                }

                Button {
                    enabled: !requesting;
                    text: @tr("åˆ·æ–°QQéªŒè¯çŠ¶æ€");
                    primary: qq-verify-code-copied;
                    clicked => { Callbacks.refresh-user-info(); }
                }
            }
        }
    }
}

export component UserCard inherits Rectangle {
    in property <UserInfo> user-info: MockData.user-info;
    out property <bool> sms-dialog-open: sms-verify-area.sms-dialog-open;
    out property <bool> qq-dialog-open: qq-verify-area.qq-dialog-open;
    private property <bool> requesting: user-info.id-api-request-state == UserIdApiRequestState.Requesting;

    public function open-qq-verify-dialog() {
        qq-verify-area.open-dialog();
    }

    public function open-sms-verify-dialog() {
        sms-verify-area.open-dialog();
    }

    border-radius: 10px;
    background: StyleMetrics.dark-color-scheme
        ? #242424
        : StyleMetrics.window-background;
    drop-shadow-blur: StyleMetrics.dark-color-scheme
        ? 0px
        : 5px;
    drop-shadow-color: darkgray;
    clip: true;

    layout := VerticalLayout {
        alignment: start;
        padding: 20px;

        GridLayout {
            spacing: 10px;

            Rectangle {
                width: 64px;
                height: 64px;
    
                border-radius: 24px;
                clip: true;
    
                Image {
                    // åšå£«å¤´åƒ
                    source: @image-url("../images/closure_logo.png");
                    width: 64px;
                    height: 64px;
                }

                row: 0;
                col: 0;
            }

            VerticalLayout {
                spacing: 2px;

                Text {
                    font-size: 12px;
                    font-family: FontGlobals.closure-studio-logo;
                    color: StyleMetrics.default-text-color.transparentize(30%);
                    text: "Doctor ID";
                    vertical-alignment: bottom;

                    height: 22px;
                }

                Text {
                    font-size: 20px;
                    font-family: FontGlobals.alphanumeric-text-sans;
                    text: user-info.nickname;
                    overflow: clip;
                    vertical-alignment: top;
                }

                row: 0;
                col: 1;
            }

            VerticalLayout {
                alignment: center;

                Button {
                    enabled: !requesting;
                    text: requesting
                        ? @tr("åˆ·æ–°ä¸­")
                        : @tr("åˆ·æ–°");
                    
                    icon: StyleMetrics.dark-color-scheme
                        ? @image-url("../images/user_card_refresh.svg")
                        : @image-url("../images/user_card_refresh_light.svg");

                    clicked => { Callbacks.refresh-user-info(); }
    
                    width: 90px;
                    height: 30px;
                }

                row: 0;
                col: 2;
            }
        }

        sms-verify-area := SmsVerifyArea {
            user-info: user-info;
            requesting: requesting;
        }

        qq-verify-area := QQVerifyArea {
            user-info: user-info;
            requesting: requesting;
        }

        GroupBox {
            title: @tr("å…¶ä»–");

            Rectangle {
                HorizontalLayout {
                    spacing: 10px;

                    Button {
                        text: @tr("å¤åˆ¶ç”¨æˆ·ID");
            
                        clicked => {
                            uuid-dummy.select-all();
                            uuid-dummy.copy();
                            uuid-dummy.clear-selection();
                        }
                    }

                    Button {
                        text: @tr("å›žåˆ°ç™»å½•ç•Œé¢");
            
                        clicked => {
                            Callbacks.return-to-login-page();
                        }
                    }

                    width: 300px;
                    height: 30px;
                    x: 0;
                    y: 0;
                }

                uuid-dummy := TextInput {
                    accessible-role: none;
                    accessible-checkable: false;
                    visible: false;
                    text: user-info.uuid;
                    width: 0;
                    height: 0;
                }
            }
        }
    }

    height: layout.min-height;
    animate height { duration: 0.25s; easing: ease; }
}

